on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or ref to deploy'
        required: true
        default: 'main'

name: Manual deploy to remote server

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Ensure rsync/ssh available
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ -n "$SSH_KNOWN_HOSTS" ]; then
            printf "%s\n" "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          else
            ssh-keyscan -p "${REMOTE_PORT:-22}" "${REMOTE_HOST}" >> ~/.ssh/known_hosts
          fi
          ssh-keygen -lf ~/.ssh/known_hosts || true

      - name: Rsync files to remote
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
        run: |
          RSYNC_EXCLUDES=(
            --exclude='.git'
            --exclude='.github'
            --exclude='vendor'
            --exclude='node_modules'
            --exclude='web/sites/default/files'
            --exclude='web/sites/default/settings.php'
            --exclude='deploy'
            --exclude='int'
            --exclude='.htaccess'
            --exclude='**/.htaccess'
            --exclude='public_html/.htaccess'
          )

          rsync -avz --delete "${RSYNC_EXCLUDES[@]}" \
            -e "ssh -p ${REMOTE_PORT:-22} -o StrictHostKeyChecking=yes" \
            ./ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}

      - name: Run composer install, fix simple permissions and drush deploy on remote
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
          REMOTE_WEBGROUP: ${{ secrets.REMOTE_WEBGROUP }}
        run: |
          ssh -p ${REMOTE_PORT:-22} ${REMOTE_USER}@${REMOTE_HOST} "set -e
            cd ${REMOTE_PATH}

            # Install PHP deps on the server (no scripts to reduce side-effects)
            composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-scripts

            # Simple, best-effort permission fixes (won't fail if permission changes are not allowed)
            #  - vendor directories: 2755 (setgid so new files inherit group)
            #  - vendor files: 0644
            #  - vendor/bin scripts: 0755
            if [ -d vendor ]; then
              find vendor -type d -exec chmod 2755 {} \; || true
              find vendor -type f -exec chmod 0644 {} \; || true
              if [ -d vendor/bin ]; then
                find vendor/bin -type f -exec chmod 0755 {} \; || true
              fi
            fi

            # Ensure uploads dir exists and is group-writable (best-effort)
            mkdir -p web/sites/default/files || true
            chmod -R 2775 web/sites/default/files || true

            # Protect settings.php (best-effort)
            if [ -f web/sites/default/settings.php ]; then
              chmod 0440 web/sites/default/settings.php || true
            fi

            # Ensure drush wrapper is executable; fallback to php invocation if needed
            if [ -f vendor/bin/drush ]; then
              chmod +x vendor/bin/drush || true
            fi

            if [ -x vendor/bin/drush ]; then
              vendor/bin/drush deploy -y
            else
              if [ -f vendor/drush/drush/drush ]; then
                php vendor/drush/drush/drush deploy -y
              else
                echo 'ERROR: drush not found' >&2
                exit 2
              fi
            fi
          "
