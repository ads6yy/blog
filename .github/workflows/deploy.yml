on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or ref to deploy'
        required: true
        default: 'main'

name: Manual deploy to remote server

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Ensure rsync/ssh available
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ -n "$SSH_KNOWN_HOSTS" ]; then
            printf "%s\n" "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          else
            ssh-keyscan -p "${REMOTE_PORT:-22}" "${REMOTE_HOST}" >> ~/.ssh/known_hosts
          fi
          ssh-keygen -lf ~/.ssh/known_hosts || true

      - name: Rsync files to remote (preserve .htaccess)
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
        run: |
          RSYNC_EXCLUDES=(
            --exclude='.git'
            --exclude='.github'
            --exclude='web/sites/default/files'
            --exclude='web/sites/default/settings.php'
            --exclude='deploy'
            --exclude='int'
          )

          # Protect .htaccess files on the destination from being deleted.
          # 'P' = protect (prevent deletion even with --delete).
          RSYNC_FILTERS=(
            --filter='P .htaccess'
          )

          # Actual deploy
          rsync -avz --delete "${RSYNC_EXCLUDES[@]}" "${RSYNC_FILTERS[@]}" \
            -e "ssh -p ${REMOTE_PORT:-22} -o StrictHostKeyChecking=yes" \
            ./ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}

      - name: Run composer install, fix simple permissions and drush deploy on remote
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
          REMOTE_WEBGROUP: ${{ secrets.REMOTE_WEBGROUP }}
        run: |
          ssh -p ${REMOTE_PORT:-22} ${REMOTE_USER}@${REMOTE_HOST} "set -e
            cd ${REMOTE_PATH}
            composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-scripts
            vendor/bin/drush deploy -y
          "
